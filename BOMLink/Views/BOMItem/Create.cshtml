@model BOMLink.ViewModels.CreateBOMItemViewModel

@{
	ViewData["Title"] = "Add BOM Item";
}

<div class="container mt-4">
	<h2>Add BOM Item</h2>
	<h5 class="text-muted">BOM Number: @Model.BOMNumber</h5>
    <form asp-action="Create" method="post">
        <input type="hidden" asp-for="BOMId" />

        <div class="mb-3">
            <label class="form-label fw-bold">Select Part</label>
            <input type="text" id="partSearch" class="form-control" placeholder="Start typing a part number..." />
            <input type="hidden" id="PartId" name="PartId" />
            <span class="text-danger" asp-validation-for="PartId"></span>
            <span class="text-danger" id="duplicateError" style="display:none;">🚫 This part is already in the BOM.</span>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Quantity</label>
            <input type="number" class="form-control" asp-for="Quantity" min="1">
            <span class="text-danger" asp-validation-for="Quantity"></span>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Notes (Optional)</label>
            <textarea class="form-control" asp-for="Notes" rows="3"></textarea>
            <span class="text-danger" asp-validation-for="Notes"></span>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-outline-primary" id="submitBtn">Add Item</button>
            <a asp-action="Index" asp-route-bomId="@Model.BOMId" class="btn btn-outline-secondary">Cancel</a>
        </div>
    </form>
</div>

    @section Scripts {
    <!-- ✅ Ensure jQuery is loaded -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- ✅ Ensure jQuery UI is loaded -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

    <!-- ✅ Load jQuery UI Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css" />

    <script>
        var existingParts = @Html.Raw(Json.Serialize(Model.ExistingPartIds));
        console.log("🚀 Existing parts (Frontend):", existingParts);

        $(document).ready(function () {
            if (!$.ui || !$.ui.autocomplete) {
                console.error("jQuery UI Autocomplete is not loaded!");
                return;
            }

            // Initialize autocomplete
            $("#partSearch").autocomplete({
                source: function (request, response) {
                    console.log("Autocomplete triggered with term:", request.term);

                    $.ajax({
                        url: "@Url.Action("SearchParts", "BOMItem")",
                        dataType: "json",
                        data: { term: request.term },
                        success: function (data) {
                            console.log("Data received:", data);
                            response($.map(data, function (item) {
                                return {
                                    label: item.partNumber + " - " + item.description,
                                    value: item.partNumber,
                                    id: item.id
                                };
                            }));
                        },
                        error: function (xhr, status, error) {
                            console.error("Error fetching data:", status, error);
                        }
                    });
                },
                select: function (event, ui) {
                    console.log("Selected part:", ui.item);

                    $("#partSearch").val(ui.item.label);
                    $("#PartId").val(ui.item.id);

                    // Validate the selected part
                    validatePartSelection(ui.item.id);

                    return false;
                }
            });

            // Validate part selection
            function validatePartSelection(selectedPartId) {
                selectedPartId = parseInt(selectedPartId, 10); // Convert to integer

                if (existingParts.includes(selectedPartId)) {
                    $("#duplicateError").show();
                    $("#submitBtn").prop("disabled", true);
                    $("#PartId").val(""); // Reset value to prevent submission
                } else {
                    $("#duplicateError").hide();
                    $("#submitBtn").prop("disabled", false);
                }
            }

            // Real-time validation as user types
            $("#partSearch").on("input", function () {
                const partId = $("#PartId").val(); // Get the selected part ID
                if (partId) {
                    validatePartSelection(partId); // Validate the selected part
                } else {
                    $("#duplicateError").hide(); // Hide error if no part is selected
                    $("#submitBtn").prop("disabled", false); // Enable submit button
                }
            });
        });
    </script>
}

